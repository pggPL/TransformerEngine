<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 850 730" width="850" height="650">
  <defs>
    <style>
      @import url("diagram-colors.css");
      /* Diagram-specific override for arrow */
      .arrow { stroke: #616161; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
    </style>
    <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="2" orient="auto">
      <polygon points="0 0, 6 2, 0 4" fill="#616161" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="425" y="30" class="title">FP8 Linear Layer – Forward and Backward Pass</text>
  
  <!-- Forward Pass Section -->
  <text x="425" y="65" class="section-title" style="fill: #1565c0;">Forward Pass</text>
  
  <!-- Forward: Input High Precision -->
  <rect x="30" y="95" width="100" height="50" class="hp" rx="6"/>
  <text x="80" y="125" class="text">Input</text>
  
  <!-- Forward: Arrow -->
  <path d="M 130 120 L 155 120" class="arrow"/>
  
  <!-- Forward: Quantize Input (centered: gap 130-270 = 140px, box 90px, margins 25px each) -->
  <rect x="155" y="95" width="90" height="50" class="quantize" rx="6"/>
  <text x="200" y="125" class="text">Quantize</text>
  
  <!-- Forward: Arrow -->
  <path d="M 245 120 L 270 120" class="arrow"/>
  
  <!-- Forward: Input FP8 -->
  <rect x="270" y="95" width="80" height="50" class="fp8" rx="6"/>
  <text x="310" y="125" class="text">Input</text>
  
  <!-- Forward: Arrow -->
  <path d="M 350 120 L 400 155" class="arrow"/>
  
  <!-- Forward: Weights High Precision -->
  <rect x="30" y="185" width="100" height="50" class="hp" rx="6"/>
  <text x="80" y="215" class="text">Weight</text>
  
  <!-- Forward: Arrow -->
  <path d="M 130 210 L 155 210" class="arrow"/>
  
  <!-- Forward: Quantize Weights (centered: gap 130-270 = 140px, box 90px, margins 25px each) -->
  <rect x="155" y="185" width="90" height="50" class="quantize" rx="6"/>
  <text x="200" y="215" class="text">Quantize</text>
  
  <!-- Forward: Arrow -->
  <path d="M 245 210 L 270 210" class="arrow"/>
  
  <!-- Forward: Weights FP8 -->
  <rect x="270" y="185" width="80" height="50" class="fp8" rx="6"/>
  <text x="310" y="215" class="text">Weights</text>
  
  <!-- Forward: Arrow -->
  <path d="M 350 210 L 400 180" class="arrow"/>
  
  <!-- Forward: GEMM -->
  <rect x="400" y="142" width="130" height="50" class="gemm" rx="6"/>
  <text x="465" y="172" class="text" style="font-weight: 600;">FP8 GEMM</text>
  
  <!-- Forward: Arrow -->
  <path d="M 530 167 L 580 167" class="arrow"/>
  
  <!-- Forward: Output -->
  <rect x="580" y="142" width="110" height="50" class="hp" rx="6"/>
  <text x="635" y="172" class="text">Output</text>
  
  <!-- Divider Line -->
  <line x1="30" y1="280" x2="820" y2="280" stroke="#ddd" stroke-width="2"/>
  
  <!-- Backward Pass Section -->
  <text x="425" y="315" class="section-title" style="fill: #c62828;">Backward Pass</text>
  
  <!-- Backward: Output gradient High Precision -->
  <rect x="30" y="441" width="130" height="50" class="hp" rx="6"/>
  <text x="95" y="471" class="text">Output grad.</text>
  
  <!-- Backward: Arrow -->
  <path d="M 160 466 L 180 466" class="arrow"/>
  
  <!-- Backward: Quantize Output gradient -->
  <rect x="180" y="441" width="90" height="50" class="quantize" rx="6"/>
  <text x="225" y="471" class="text">Quantize</text>
  
  <!-- Backward: Arrow to Output grad -->
  <path d="M 270 450 L 290 425" class="arrow"/>
  <!-- Backward: Arrow to Output grad transpose -->
  <path d="M 270 482 L 290 505" class="arrow"/>
  
  <!-- Backward: Output gradient FP8 (for input gradient) -->
  <rect x="290" y="400" width="110" height="50" class="fp8" rx="6"/>
  <text x="345" y="430" class="text">Output grad.</text>
  
  <!-- Backward: Output gradient FP8 transpose (for weight gradient) -->
  <rect x="290" y="480" width="110" height="50" class="fp8" rx="6"/>
  <text x="345" y="510" class="text">Output grad.ᵀ</text>
  
  <!-- Top GEMM path -->
  <!-- Backward: Weight transpose -->
  <rect x="440" y="330" width="90" height="40" class="fp8" rx="6"/>
  <text x="485" y="355" class="text">Weightᵀ</text>
  
  <!-- Backward: GEMM 1 (for input gradient) -->
  <rect x="420" y="400" width="130" height="50" class="gemm" rx="6"/>
  <text x="485" y="430" class="text" style="font-weight: 600;">FP8 GEMM</text>
  
  <!-- Backward: Input gradient -->
  <rect x="590" y="400" width="130" height="50" class="hp" rx="6"/>
  <text x="655" y="430" class="text">Input grad.</text>
  
  <!-- Bottom GEMM path -->
  <!-- Backward: Input transpose -->
  <rect x="440" y="560" width="90" height="40" class="fp8" rx="6"/>
  <text x="485" y="585" class="text">Inputᵀ</text>
  
  <!-- Backward: GEMM 2 (for weight gradient) -->
  <rect x="420" y="480" width="130" height="50" class="gemm" rx="6"/>
  <text x="485" y="510" class="text" style="font-weight: 600;">FP8 GEMM</text>
  
  <!-- Backward: Weight gradient -->
  <rect x="590" y="480" width="130" height="50" class="hp" rx="6"/>
  <text x="655" y="510" class="text">Weight grad.</text>
  
  <!-- Backward: Arrows -->
  <!-- Output gradient FP8 to top GEMM -->
  <path d="M 400 425 L 420 425" class="arrow"/>
  <!-- Weight transpose to top GEMM -->
  <path d="M 485 370 L 485 400" class="arrow"/>
  <!-- Top GEMM to input gradient -->
  <path d="M 550 425 L 590 425" class="arrow"/>
  
  <!-- Output gradient FP8 transpose to bottom GEMM -->
  <path d="M 400 505 L 420 505" class="arrow"/>
  <!-- Input transpose to bottom GEMM -->
  <path d="M 485 560 L 485 530" class="arrow"/>
  <!-- Bottom GEMM to weight gradient -->
  <path d="M 550 505 L 590 505" class="arrow"/>
  
  <!-- Legend -->
  <g transform="translate(30, 620)">
    <!-- Higher Precision -->
    <rect x="0" y="0" width="80" height="40" rx="5" class="hp"/>
    <text x="95" y="23" class="text" style="text-anchor: start;">Higher Precision (FP32/BF16/FP16)</text>
    
    <!-- Lower Precision -->
    <rect x="380" y="0" width="80" height="40" rx="5" class="fp8"/>
    <text x="475" y="23" class="text" style="text-anchor: start;">Lower Precision (FP8, MXFP8 etc.)</text>
    
    <!-- Quantize -->
    <rect x="0" y="55" width="80" height="40" rx="5" class="quantize"/>
    <text x="95" y="78" class="text" style="text-anchor: start;">Quantization (FP32→FP8)</text>
  </g>
  
</svg>

